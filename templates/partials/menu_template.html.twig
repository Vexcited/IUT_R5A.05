{% extends 'knp_menu.html.twig' %}

{% import _self as macros %}

{% block list %}
    {% if item.hasChildren and options.depth is not same as(0) and item.displayChildren %}
        <ul class="nav flex-column submenu{{ item.level > 1 ? ' submenu-level-' ~ item.level : '' }}">
            {{ block('children') }}
        </ul>
    {% endif %}
{% endblock %}

{% block item %}
    {% if item.displayed %}
        {%- set attributes = item.attributes %}
        {%- set is_dropdown = attributes.dropdown|default(false) %}
        {%- set divider_prepend = attributes.divider_prepend|default(false) %}
        {%- set divider_append = attributes.divider_append|default(false) %}

        {# unset bootstrap specific attributes #}
        {%- set attributes = attributes|merge({'dropdown': null, 'divider_prepend': null, 'divider_append': null }) %}

        {% if divider_prepend %}
            {{ block('dividerElement') }}
        {% endif %}

        {# building the class of the item #}
        {%- set classes = item.attribute('class') is not empty ? [item.attribute('class')] : [] %}
        {%- if matcher.isCurrent(item) %}
            {%- set classes = classes|merge([options.currentClass]) %}
        {%- elseif matcher.isAncestor(item, options.matchingDepth) %}
            {%- set classes = classes|merge([options.ancestorClass]) %}
        {%- endif %}
        {%- if item.actsLikeFirst %}
            {%- set classes = classes|merge([options.firstClass]) %}
        {%- endif %}
        {%- if item.actsLikeLast %}
            {%- set classes = classes|merge([options.lastClass]) %}
        {%- endif %}

        {%- if item.hasChildren and options.depth is not same as(0) %}
            {% if options.branch_class is not empty and item.displayChildren %}
                {%- set classes = classes|merge([options.branch_class]) %}
            {% endif %}
        {% elseif options.leaf_class is not empty %}
            {%- set classes = classes|merge([options.leaf_class]) %}
        {%- endif %}

        {%- set attributes = attributes|merge({'class': classes|join(' ')}) %}
        {# building the class of the children #}
        {%- set childrenClasses = item.childrenAttribute('class') is not empty ? [item.childrenAttribute('class')] : [] %}
        {%- set childrenClasses = childrenClasses|merge(['menu_level_' ~ item.level]) %}
        {%- set childrenAttributes = item.childrenAttributes|merge({'class': childrenClasses|join(' ')}) %}
        {# displaying the item #}
        <li{{ macros.attributes(attributes) }}>
            {%- if is_dropdown %}
                {{ block('dropdownElement') }}
            {%- elseif item.uri is not empty and (not item.current or options.currentAsLink) %}
                {{ block('linkElement') }}
            {%- else %}
                {{ block('spanElement') }}
            {%- endif %}
            {# render the list of children#}
            {%- set childrenClasses = childrenClasses|merge(['dropdown-menu']) %}
            {%- set childrenAttributes = childrenAttributes|merge({'class': childrenClasses|join(' ')}) %}
            {{ block('list') }}
        </li>

        {% if divider_append %}
            {{ block('dividerElement') }}
        {% endif %}
    {% endif %}
{% endblock %}

{% block linkElement %}
    {%- set classes = item.linkAttribute('class') is not empty ? [item.linkAttribute('class')] : [] %}
    {%- set classes = classes|merge(['nav-link']) %}
    {%- if item.level > 1 %}
        {%- set classes = classes|merge(['nav-link-submenu']) %}
    {%- endif %}
    {%- if matcher.isCurrent(item) %}
        {%- set classes = classes|merge(['active']) %}
    {%- endif %}
    {%- set attributes = item.linkAttributes|merge({'class': classes|join(' ')}) %}
    <a href="{{ item.uri }}"{{ macros.attributes(attributes) }}>
        {% if item.attribute('icon') %}
            <i class="bi bi-{{ item.attribute('icon') }}"></i>
        {% endif %}
        {{ block('label') }}
        {% if item.hasChildren %}
            <i class="bi bi-chevron-down float-end"></i>
        {% endif %}
    </a>
{% endblock %}

{% block spanElement %}
    {%- set classes = item.labelAttribute('class') is not empty ? [item.labelAttribute('class')] : [] %}
    {%- set classes = classes|merge(['nav-link', 'disabled']) %}
    {%- set attributes = item.labelAttributes|merge({'class': classes|join(' ')}) %}
    <span{{ macros.attributes(attributes) }}>
        {% if item.attribute('icon') %}
            <i class="bi bi-{{ item.attribute('icon') }}"></i>
        {% endif %}
        {{ block('label') }}
    </span>
{% endblock %}
